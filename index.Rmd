---
title: "策略运营组"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    orientation: rows
    theme: spacelab

params:
  cur_date: "`r Sys.Date()`"
  n_month_overall: 6
  n_month: 3
  cur_x: 10
---

```{r setup, include=FALSE}
knitr::read_chunk('setup.R')
```

```{r setup, echo=FALSE, cache=FALSE}
```

学期 {data-icon="fa-globe"}
=====================================

数据更新至 `r max(dat$l1_pay_time, na.rm = TRUE)`

```{r, echo=FALSE}
by_term <- dat %>% 
    filter(classopen_date > Sys.Date() - 30*3) %>% 
    group_by(term_id, term_name, term_remarks, classopen_date) %>% 
    summarise(
      .groups = "keep",
      enroll_total = n_distinct(user_id, na.rm = TRUE),
      grade_low_prop = mean(package_grade == "LOW", na.rm = TRUE),
      referral_rate = mean(l1_order_channel == "转介绍", na.rm = TRUE),
      city_level_2_prop = mean(ifelse(phone_city_level %in% c("一线","新一线","二线"),
                                      1, 0)),
      ct_total = n_distinct(counselor_id, na.rm = TRUE),
      ct_enroll_total = round(enroll_total/ct_total),
      apply_total = n_distinct(ifelse(is_renewal == 1, user_id, NA), na.rm = TRUE),
      apply_rate = apply_total/enroll_total,
      apply_2_rate = n_distinct(ifelse(is_renewal_2 == 1, user_id, NA), na.rm = TRUE)/enroll_total,
      subscribe_rate = mean(is_subscribe, na.rm = TRUE),
      #subscribe_rate_1 = mean(ifelse(difftime(first_sub_time, l1_pay_time) <= 0, 1, 0)),
      add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
      across(c(unit1_attend_time, unit5_finish_time),
             ~ mean(ifelse(is.na(.x), 0, 1)),
             .names = "{.col}_rate"),
      unit5_apply_rate = apply_rate/unit5_finish_time_rate
    ) %>% 
    #arrange(desc(classopen_date)) %>% 
    mutate(
      across(ends_with("rate"), ~ round(.x *100, 1)),
      across(ends_with("prop"), ~ round(.x *100, 0))
      ) %>%
    mutate(
      status = ifelse(Sys.Date() <= classopen_date, 
                      paste0("距开课", difftime(classopen_date, Sys.Date()), "天"), 
                  ifelse(apply_rate > 2, "续报",
                    ifelse(unit5_finish_time_rate > 1, "5课完", 
                       ifelse(unit1_attend_time_rate > 1, "开课中", ""))))
    ) %>% 
    relocate(group_cols(), status,
           starts_with("enroll_"), starts_with("apply_"),
           starts_with("ct_"))
```

```{r}
by_term_name <- dat %>% 
    filter(classopen_date > Sys.Date() - 30*3,
           !str_detect(term_remarks, "召回")) %>% 
    group_by(term_name) %>% 
    summarise(
      classopen_date = min(classopen_date),
      .enroll_total = n_distinct(user_id, na.rm = TRUE),
      grade_low_rate = mean(package_grade == "LOW", na.rm = TRUE),
      referral_rate = mean(l1_order_channel == "转介绍", na.rm = TRUE),
      grade_8_rate = mean(pay_grade == 8, na.rm = TRUE),
      ct_total = n_distinct(counselor_id, na.rm = TRUE),
      ct_new_rate = mean(n_term == 1, na.rm = TRUE),
      class_size = round(.enroll_total/ct_total),
      apply_total = n_distinct(ifelse(is_apply == 1, user_id, NA), na.rm = TRUE),
      apply_rate = apply_total/.enroll_total,
      apply_2_rate = n_distinct(ifelse(is_renewal_2 == 1, user_id, NA), na.rm = TRUE)/.enroll_total,
      add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
      unit1_attend_rate = mean(ifelse(is.na(unit1_attend_time), 0, 1)),
      unit5_finish_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1))
    ) %>% 
    arrange(desc(classopen_date)) %>% 
    mutate(
      enroll_total = paste0(round(.enroll_total/1000, 0), "k"),
      across(ends_with("rate"), ~ round(.x *100, 1))
      ) %>%
    select(-starts_with(".")) %>% 
    select(term_name, 
           starts_with("enroll_"), starts_with("apply_"),
           ct_total, ct_new_rate, class_size, 
           everything())
```

Row {.tabset .tabset-fade data-height=550}
-------------------------------------

### 总续报率

```{r}
res <- dat %>% 
    filter(classopen_date > Sys.Date() - 30*params$n_month_overall,
           !str_detect(term_remarks, "召回")) %>% 
    group_by(term_name) %>% 
    summarise(
      .groups = "keep",
      enroll_total = n_distinct(user_id, na.rm = TRUE),
      apply_d1_rate = n_distinct(ifelse(is_apply == 1 & renewal_dayn <= 0, user_id, NA), 
                                 na.rm = TRUE)/enroll_total,
      apply_d2_rate = n_distinct(ifelse(is_apply == 1 & renewal_dayn <= 1, user_id, NA), 
                                 na.rm = TRUE)/enroll_total,
      apply_d3_rate = n_distinct(ifelse(is_apply == 1 & renewal_dayn <= 2, user_id, NA), 
                                 na.rm = TRUE)/enroll_total,
      apply_d4_rate = n_distinct(ifelse(is_apply == 1 & renewal_dayn <= 3, user_id, NA), 
                           na.rm = TRUE)/enroll_total,
      apply_rate = n_distinct(ifelse(is_apply == 1, user_id, NA), 
                                 na.rm = TRUE)/enroll_total,
      unit5_finish_time_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1)),
      apply_5f_rate = apply_rate/unit5_finish_time_rate
    ) %>% 
    mutate(
      across(ends_with("rate"), ~ round(.x *100, 1))
      ) %>% 
    filter(apply_rate > 1) 
```

```{r}
highchart() %>%
  hc_add_series(res, "line", hcaes(x = term_name, y = apply_d1_rate, size = enroll_total), 
                name = "首日续报", color = "black", 
                dataLabels = list(enabled = TRUE, verticalAlign = list('bottom'))) %>% 
  hc_add_series(res, "line", hcaes(x = term_name, y = apply_d2_rate), 
                name = "2日续报", color = "#D3D3D3") %>% 
  hc_add_series(res, "line", hcaes(x = term_name, y = apply_d3_rate), 
                name = "3日续报", color = "silver") %>% 
  hc_add_series(res, "line", hcaes(x = term_name, y = apply_d4_rate), 
                name = "4日续报", color = "silver") %>% 
  hc_add_series(res, "line", hcaes(x = term_name, y = apply_rate), 
                name = "总续报(不含召回)", color = "#00b6eb", 
                dataLabels = list(enabled = TRUE)) %>%
  hc_xAxis(title = "", type = "category", categories = res$term_name, 
           labels = list(align = "right", rotation =  -45, overflow = none, direction = "rtl") ) %>% 
  hc_yAxis(text = "续报率") %>% 
  hc_legend(verticalAlign = "top")
```

### 微信率

```{r}
res <- dat %>% 
    filter(classopen_date > Sys.Date() - 30*params$n_month_overall,
           str_detect(term_remarks, "常规")) %>% 
    mutate(
      is_add_wx = ifelse(is.na(add_wx_time), 0, 1),
      addWx_dayn = as.Date(add_wx_time) - as.Date(user_class_start_time)) %>% 
    group_by(term_name) %>% 
    summarise(
      .groups = "keep",
      enroll_total = n_distinct(user_id, na.rm = TRUE),
      y1_rate = n_distinct(ifelse(is_add_wx == 1 & addWx_dayn <= 0, user_id, NA), 
                                 na.rm = TRUE)/enroll_total,
      y2_rate = n_distinct(ifelse(is_add_wx == 1 & addWx_dayn <= 1, user_id, NA), 
                                 na.rm = TRUE)/enroll_total,
      y3_rate = n_distinct(ifelse(is_add_wx == 1 & addWx_dayn <= 2, user_id, NA), 
                                 na.rm = TRUE)/enroll_total,
      y4_rate = mean(ifelse(is.na(add_wx_time), 0, 1))
    ) %>% 
    mutate(
      across(ends_with("rate"), ~ round(.x *100, 0))
      ) %>% 
    filter(y4_rate > 10) 
```

```{r}
highchart() %>%
  hc_add_series(res, "line", hcaes(x = term_name, y = y1_rate, size = enroll_total), 
                name = "首日微信率", color = "grey") %>% 
  hc_add_series(res, "line", hcaes(x = term_name, y = y2_rate), 
                name = "2日微信率", color = "silver") %>% 
  hc_add_series(res, "line", hcaes(x = term_name, y = y3_rate), 
                name = "3日微信率", color = "silver") %>%
  hc_add_series(res, "line", hcaes(x = term_name, y = y4_rate), 
                name = "总微信率（常规）", color = "black") %>%
  hc_xAxis(title = "", type = "category", categories = res$term_name, 
           labels = list(align = "right", rotation =  -45, overflow = none) ) %>% 
  hc_yAxis(text = "微信率") %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### 流量池

```{r}
res <- dat %>% 
    filter(classopen_date > Sys.Date() - 30*params$n_month_overall,
           str_detect(term_remarks, "常规")) %>% 
    mutate(
      dayn = as.Date(user_class_start_time) - as.Date(l1_pay_time)) %>% 
    group_by(term_label) %>% 
    summarise(
      .groups = "keep",
      enroll_total = n_distinct(user_id, na.rm = TRUE),
      y1_rate = n_distinct(ifelse(difftime(user_class_start_time,
                                           l1_pay_time, units = "hours") < 1.5, 
                                  user_id, NA), na.rm = TRUE)/enroll_total,
      y2_rate = n_distinct(ifelse(dayn <= 1, user_id, NA), na.rm = TRUE)/enroll_total,
      y3_rate = n_distinct(ifelse(dayn <= 2, user_id, NA), na.rm = TRUE)/enroll_total
    ) %>% 
    mutate(
      across(ends_with("rate"), ~ round(.x *100, 0))
      ) 
```


```{r}
highchart() %>%
  hc_add_series(res, "line", hcaes(x = term_label, y = y1_rate), 
                name = "立即进班(<1.5h)", color = "black") %>% 
  hc_add_series(res, "line", hcaes(x = term_label, y = y2_rate), 
                name = "2日内进班", color = "black") %>% 
  hc_add_series(res, "line", hcaes(x = term_label, y = y3_rate), 
                name = "3日内进班", color = "silver") %>% 
  hc_xAxis(title = "", type = "category", categories = res$term_label, 
           labels = list(align = "right", rotation =  -45, overflow = none) ) %>% 
  hc_yAxis(text = "进班率") %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### 过程数据

```{r}
res <- dat %>% 
  filter(classopen_date > Sys.Date() - 30,
           str_detect(term_remarks, "常规")) %>% 
  group_by(term_label) %>% 
  summarise(
    add_wx_rate = round(mean(ifelse(is.na(add_wx_time), 0, 1))*100, 0)
  ) %>% 
  left_join(
    dat %>% 
      filter(classopen_date > Sys.Date() - 30) %>% 
      group_by(term_label) %>% 
      getRates_detail(),
    by = c("term_label")
  ) %>% 
  pivot_longer(
    cols = ends_with("rate"),
    names_to = "stage",
    values_to = "rate"
  ) %>% 
  mutate(rate = ifelse(rate == 0, NA, rate))
```

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", hcaes(x = stage, y = rate, group = term_label),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$stage)) %>% 
  hc_legend(verticalAlign = "top")
```

Row {.tabset .tabset-fade data-height=900}
-------------------------------------

### 班型数据

```{r}
res <- dat_class %>% 
  group_by(group_class, term_name) %>% 
  getRates() %>% 
  mutate(
      apply_diff_rate = apply_rate - lag(apply_rate, order_by = term_name)
    ) 
```

```{r}
showDT(
  res %>% 
     arrange(desc(term_name)) %>% 
     select(-enroll_rate, -apply_total) %>% 
     relocate(term_name, group_class, starts_with("enroll"), starts_with("apply")) 
)
```

### 学期数据

```{r}
showDT(
  by_term %>%
    arrange(desc(classopen_date))
)
```

### 学期整体

```{r}
showDT(by_term_name)
```

班型总览 {data-height=550}
=====================================

```{r}
grp_data  <-  dat_class %>% 
  filter(
    classopen_date > Sys.Date() - 30*1.5,
    !is.na(group_class),
    group_class %in% c("专业编程","温度编程","转介绍","老用户召回")
     ) %>%
  group_by(term_name, group_class)

by_term_seg <- getRates(grp_data) %>% 
  filter(enroll_rate > 5)

by_term_seg_hct <- grp_data %>% 
  filter(!is.na(group_name)) %>% 
  group_by(term_name, group_class, group_city, group_name) %>% 
  filter(n() > 50) %>% 
  getRates()

by_term_seg_hct_ct <- grp_data %>% 
  filter(!is.na(group_name)) %>% 
  group_by(term_name, group_class, group_city, group_name, counselor_name) %>% 
  filter(n() > 40) %>% 
  getRates()
```

```{r}
plot_seg_overview <- function(data, metric) {
  gg = by_term_seg %>% 
    ggplot(aes_string(x = "term_name", y = metric)) + 
      geom_line(aes(group = group_class, text = paste0("在班人数:",enroll_rate)),
                color = "grey") + 
      geom_point(color = "grey", size = 0.5) +
      geom_boxplot(color = "grey", outlier.shape = 1, data = data) +
      geom_text(aes_string(label = metric), nudge_y = 0.5) + 
      facet_grid(. ~ group_class, scales = "free") +
      labs(x = "", y = "") +
      scale_color_discrete(name = "基地")
  
  if("counselor_name" %in% names(data)) {
    gg = gg + 
      geom_point(aes(color = group_city,
                     text = paste0(group_name,"-", counselor_name,"-",enroll_total)), 
                 size = 0.8, data = data)
  } else {
    gg = gg + 
      geom_point(aes(color = group_city,
                     text = paste0(group_name,"-", ct_total,"-",enroll_total)), 
                 size = 0.8, data = data)
  }
  
  ggplotly(gg)
}
```

Row {.tabset .tabset-fade data-height=550}
-------------------------------------

### 续报率-hct

```{r}
plot_seg_overview(by_term_seg_hct, "apply_rate")
```

### 续报率-ct

```{r}
plot_seg_overview(by_term_seg_hct_ct, "apply_rate")
```

Row {.tabset .tabset-fade data-height=550}
-------------------------------------

### 微信添加率-hct

```{r}
plot_seg_overview(by_term_seg_hct, "add_wx_rate")
```

### 微信添加率-ct

```{r}
plot_seg_overview(by_term_seg_hct_ct, "add_wx_rate")
```

Row {.tabset .tabset-fade data-height=550}
-------------------------------------

### 首课到课率-hct

```{r}
plot_seg_overview(by_term_seg_hct, "unit1_attend_rate")
```

### 首课到课率-ct

```{r}
plot_seg_overview(by_term_seg_hct_ct, "unit1_attend_rate")
```

Row {.tabset .tabset-fade data-height=550}
-------------------------------------

### 5课完课率-hct

```{r}
plot_seg_overview(by_term_seg_hct, "unit5_finish_rate")
```

### 5课完课率-ct

```{r}
plot_seg_overview(by_term_seg_hct_ct, "unit5_finish_rate")
```

Row {.tabset .tabset-fade data-height=550}
-------------------------------------

### 留存率-hct

```{r}
plot_seg_overview(by_term_seg_hct, "retent_rate")
```

### 留存率-ct

```{r}
plot_seg_overview(by_term_seg_hct_ct, "retent_rate")
```

Row {.tabset .tabset-fade data-height=550}
-------------------------------------

### 完课续报率-hct

```{r}
plot_seg_overview(by_term_seg_hct, "unit5_apply_rate")
```

### 完课续报率-ct

```{r}
plot_seg_overview(by_term_seg_hct_ct, "unit5_apply_rate")
```

Row {.tabset .tabset-fade data-height=800}
-------------------------------------

### 班型-渠道占比及续报率

```{r}
grp_data  <-  dat_class %>% 
  filter(
    classopen_date > Sys.Date() - 30*1.5,
    group_class %in% c("专业编程", "温度编程")
     ) %>%
  group_by(term_name, group_class, l1_order_channel)

res <- grp_data %>% 
  getRates() %>% 
  filter(enroll_rate > 1)
```

```{r fig.height=60}
gg <- res %>% 
  ggplot(aes(x = term_name, y = apply_rate)) + 
    geom_point(aes(color = group_class, text = paste0("在班人数：", enroll_total))) +
    geom_line(aes(group = group_class, color = group_class, 
                   text = paste0("在班人数:",enroll_rate))) + 
    geom_text(aes(label = apply_rate), nudge_y = 5, size = 3) + 
    geom_bar(aes(x = term_name, y = enroll_rate), stat="identity", alpha = 0.5) + 
    facet_grid(group_class ~ l1_order_channel, scales = "free") +
    labs(x = "", y = "") + 
    theme(legend.position = "none")
ggplotly(gg)
```

### 班型-城市等级占比及续报率

```{r}
grp_data  <-  dat_class %>% 
  filter(
    classopen_date > Sys.Date() - 30*1.5,
    group_class %in% c("专业编程", "温度编程")
     ) %>%
  group_by(term_name, group_class, phone_city_level)

res <- grp_data %>% 
  getRates() %>% 
  filter(enroll_rate > 1)
```

```{r fig.height=80}
gg <- res %>% 
  ggplot(aes(x = term_name, y = apply_rate)) + 
    geom_point(aes(color = group_class, text = paste0("在班人数：", enroll_total))) +
    geom_line(aes(group = group_class, color = group_class, 
                   text = paste0("在班人数:",enroll_rate))) + 
    geom_text(aes(label = apply_rate), nudge_y = 5, size = 3) + 
    geom_bar(aes(x = term_name, y = enroll_rate), stat="identity", alpha = 0.5) + 
    facet_grid(group_class ~ phone_city_level, scales = "free") +
    labs(x = "", y = "") + 
    theme(legend.position = "none")
ggplotly(gg)
```

### 班型-基地占比及续报率

```{r}
grp_data  <-  dat_class %>% 
  filter(
    classopen_date > Sys.Date() - 30*1.5,
    group_class %in% c("专业编程", "温度编程")
     ) %>%
  group_by(term_name, group_class, group_city)

res <- grp_data %>% 
  getRates() %>% 
  filter(enroll_rate > 1)
```

```{r fig.height=60}
gg <- res %>% 
  ggplot(aes(x = term_name, y = apply_rate)) + 
    geom_point(aes(color = group_class, text = paste0("在班人数：", enroll_total))) +
    geom_line(aes(group = group_class, color = group_class, 
                   text = paste0("在班人数:",enroll_rate))) + 
    geom_text(aes(label = apply_rate), nudge_y = 5, size = 3) + 
    geom_bar(aes(x = term_name, y = enroll_rate), stat="identity", alpha = 0.5) + 
    facet_grid(group_class ~ group_city, scales = "free") +
    labs(x = "", y = "") + 
    theme(legend.position = "none")
ggplotly(gg)
```

渠道
=====================================



```{r channel}
by_term_channel <- dat %>%
    filter(classopen_date > Sys.Date() - 180,
           !is.na(l1_order_channel)
          ) %>% 
    group_by(classopen_date, term_label, l1_order_channel) %>%
    summarise(
      .groups = "drop_last",
      enroll_total = n_distinct(user_id, na.rm = TRUE),
      apply_rate = mean(is_apply, na.rm = TRUE),
      add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
      subscribe_rate = mean(is_subscribe, na.rm = TRUE),
      unit1_attend_rate = mean(ifelse(is.na(unit1_attend_time), 0, 1)),
      unit5_finish_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1)),
      retent_rate = unit5_finish_rate/unit1_attend_rate,
      unit5_apply_rate = apply_rate/unit5_finish_rate,
      grade_low_rate = mean(package_grade == "LOW", na.rm = TRUE),
      grade_8_rate = mean(pay_grade == 8, na.rm = TRUE),
      price_0_rate = mean(l1_pay_amount == 0, na.rm = TRUE)
      ) %>% 
    mutate(
      enroll_rate = enroll_total/sum(enroll_total),
      across(ends_with("rate"), ~ round(.x *100, 1))
      ) %>% 
    group_by(l1_order_channel, .add = TRUE) %>% 
    relocate(group_cols(),
           starts_with("enroll_"))
```

```{r}
by_term_seg_channel <- dat_class %>%
    filter(classopen_date > Sys.Date() - 30*2,
           !is.na(l1_order_channel)
          ) %>% 
    group_by(term_name, group_class, l1_order_channel) %>%
    getRates()
```



专业编程
-------------------------------------

### 渠道占比

```{r}
res <- filter(by_term_seg_channel, group_class == "专业编程")

highchart() %>% 
  hc_add_series(res, 
                type = "line", 
                hcaes(x = term_name, y = enroll_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_name)) %>% 
  hc_colors(color$channel) %>% 
  hc_legend(verticalAlign = "top")
```

### 渠道续报率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1), type = "line", 
                hcaes(x = term_name, y = apply_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_name)) %>% 
  hc_colors(color$channel[-length(color$channel)]) %>% 
  hc_legend(verticalAlign = "top")
```

温度编程
-------------------------------------

### 渠道占比

```{r}
res <- filter(by_term_seg_channel, group_class == "温度编程")

highchart() %>% 
  hc_add_series(res, 
                type = "line", 
                hcaes(x = term_name, y = enroll_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_name)) %>% 
  hc_colors(color$channel) %>% 
  hc_legend(verticalAlign = "top")
```

### 渠道续报率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1), type = "line", 
                hcaes(x = term_name, y = apply_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_name)) %>% 
  hc_colors(color$channel[-length(color$channel)]) %>% 
  hc_legend(verticalAlign = "top")
```

老用户召回
-------------------------------------

### 渠道占比

```{r}
res <- filter(by_term_seg_channel, group_class == "老用户召回")

highchart() %>% 
  hc_add_series(res, 
                type = "line", 
                hcaes(x = term_name, y = enroll_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_name)) %>% 
  hc_colors(color$channel) %>% 
  hc_legend(verticalAlign = "top")
```

### 渠道续报率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1), type = "line", 
                hcaes(x = term_name, y = apply_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_add_series(filter(res, enroll_rate > 1), type = "scatter", 
                hcaes(x = term_name, y = apply_rate,
                      group = l1_order_channel, size = enroll_rate), 
                maxSize = "15%") %>%
  hc_xAxis(title = "", type = "category", categories = unique(res$term_name)) %>% 
  hc_colors(color$channel[-length(color$channel)]) %>% 
  hc_legend(verticalAlign = "top")
```

Row
-------------------------------------

### 渠道占比

```{r}
res <- by_term_channel %>% 
  filter(
    classopen_date > Sys.Date() - 30*2,
    str_detect(term_label, "常规|分层"),
    !str_detect(term_label, "1435|1905"), # 春16期包含858测试
    enroll_total > 80
    ) %>% 
  mutate(
    across(ends_with("rate"), ~ ifelse(.x < 1, NA, .x))
    )

highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_label, y = enroll_rate, group = l1_order_channel)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_colors(color$channel) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))

```


### 渠道续报率


```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1), type = "line", 
                hcaes(x = term_label, y = apply_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_add_series(filter(res, enroll_rate > 1), type = "scatter", 
                hcaes(x = term_label, y = apply_rate,
                      group = l1_order_channel, size = enroll_rate), 
                maxSize = "15%") %>%
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_colors(color$channel[-length(color$channel)]) %>% 
  hc_legend(verticalAlign = "top")
```

Row
-------------------------------------

### 渠道首课到课率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1), type = "line", 
                hcaes(x = term_label, y = unit1_attend_rate, group = l1_order_channel)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "率") %>% 
  hc_colors(color$channel) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### 渠道完课率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1), type = "line", 
                hcaes(x = term_label, y = unit5_finish_rate, group = l1_order_channel)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "5课完课率") %>% 
  hc_colors(color$channel) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### 渠道完课续报率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1), type = "line", 
                hcaes(x = term_label, y = unit5_apply_rate, group = l1_order_channel)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "完课续报率") %>% 
  hc_colors(color$channel) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE),
            marker = list(radius = 3)
          ))
```

Row {.tabset .tabset-fade}
-------------------------------------

```{r}
grp_data <- dat %>% 
  filter(
    !is.na(l1_order_channel),
    !term_name %in% c("2021春季-第16期")
  ) %>% 
  group_by(term_name, l1_order_channel)

res <- getRates(grp_data)
```

### 渠道占比
```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_name, y = enroll_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_name)) %>% 
  hc_colors(color$channel) %>%
  hc_legend(verticalAlign = "top")
```


### 渠道续报率

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_name, y = apply_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_colors(color$channel) %>%
  hc_legend(verticalAlign = "top")
```

### 渠道招生量

```{r}
ggplotly({
  res %>% 
  ggplot( aes(x = term_name)) +
      geom_bar(aes(y = enroll_total, fill = l1_order_channel), 
               alpha = 0.7, stat = "identity") +
      geom_line(aes(y = apply_rate)) +
      labs(x = "", y = "") +
      scale_fill_discrete(name = "渠道")
})
```

Row
-------------------------------------

```{r}
by_term_channel <- dat %>%
    filter(classopen_date > Sys.Date() - 180,
           !is.na(l1_order_channel)
          ) %>% 
    group_by(classopen_date, term_name, l1_order_channel) %>%
    summarise(
      .groups = "drop_last",
      enroll_total = n_distinct(user_id, na.rm = TRUE),
      apply_rate = mean(is_apply, na.rm = TRUE),
      add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
      subscribe_rate = mean(is_subscribe, na.rm = TRUE),
      unit1_attend_rate = mean(ifelse(is.na(unit1_attend_time), 0, 1)),
      unit5_finish_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1)),
      retent_rate = unit5_finish_rate/unit1_attend_rate,
      unit5_apply_rate = apply_rate/unit5_finish_rate,
      grade_low_rate = mean(package_grade == "LOW", na.rm = TRUE),
      grade_8_rate = mean(pay_grade == 8, na.rm = TRUE),
      price_0_rate = mean(l1_pay_amount == 0, na.rm = TRUE)
      ) %>% 
    mutate(
      enroll_rate = enroll_total/sum(enroll_total),
      across(ends_with("rate"), ~ round(.x *100, 1))
      ) %>% 
    group_by(l1_order_channel, .add = TRUE) %>% 
    relocate(group_cols(),
           starts_with("enroll_"))

showDT(
  by_term_channel %>% 
  mutate(
      apply_diff_rate = apply_rate - lag(apply_rate, order_by = term_name)
    ) %>% 
  ungroup() %>% select(-classopen_date) %>% 
  group_by(term_name,l1_order_channel)
)
```

班主任
=====================================

```{r data_term_hct_ct, include=FALSE}
by_term_hct_ct <- dat %>%
    filter(
      classopen_date > Sys.Date() - 30*params$n_month
    ) %>% 
    group_by(term_label,
             group_city, group_name, 
             counselor_id, counselor_name, classopen_staff_id, n_term) %>%
    summarise(
      .groups = "keep",
      term_id = min(term_id),
      classopen_date = min(classopen_date),
      enroll_total = n_distinct(user_id, na.rm = TRUE),
      apply_total = n_distinct(ifelse(is_apply == 1, user_id, NA), na.rm = TRUE),
      apply_rate = apply_total/enroll_total,
      apply_high_rate = n_distinct(ifelse((is_apply == 1 & package_grade == "HIGH"),
                        user_id, NA), na.rm = TRUE)/n_distinct(ifelse(package_grade == "HIGH",
                        user_id, NA), na.rm = TRUE),
      apply_low_rate = n_distinct(ifelse((is_apply == 1 & package_grade == "LOW"),
                  user_id, NA), na.rm = TRUE)/n_distinct(ifelse(package_grade == "LOW",
                  user_id, NA), na.rm = TRUE),
      add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
      grade_low_rate = mean(package_grade == "LOW", na.rm = TRUE),
      unit1_attend_rate = mean(ifelse(is.na(unit1_attend_time), 0, 1)),
      unit5_finish_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1)),
      unit5_apply_rate = apply_rate/unit5_finish_rate
      ) %>% 
    mutate(
      across(ends_with("rate"), ~ round(.x *100, 1))
      ) %>% 
    group_by(term_id) %>% 
    mutate(rank = round(percent_rank(apply_rate)*100, 0)) %>% 
    group_by(term_label,
           group_city, group_name, 
           counselor_name, n_term) %>%
    filter(enroll_total > 40) %>% 
    relocate(group_cols(),
           starts_with("enroll_"), starts_with("apply_"))
```

```{r}
by_term_hct <-  dat %>%
  filter(classopen_date > Sys.Date() - 30*params$n_month,
         !is.na(group_name)) %>% 
  group_by(term_label, group_city, group_name) %>%
  summarise(
    .groups = "keep",
    enroll_total = n_distinct(user_id, na.rm = TRUE),
    ct_total = n_distinct(counselor_id, na.rm = TRUE),
    ct_new_total = n_distinct(ifelse(n_term == 1, counselor_id, NA), na.rm = TRUE),
    apply_total = n_distinct(ifelse(is_apply == 1, user_id, NA), na.rm = TRUE),
    apply_rate = apply_total/enroll_total,
    add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
    unit1_attend_rate = mean(ifelse(is.na(unit1_attend_time), 0, 1)),
    unit5_finish_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1)),
    #loss_1_5_rate = 1 - unit5_finish_rate/unit1_attend_rate,
    grade_low_rate = mean(package_grade == "LOW", na.rm = TRUE),
    referral_rate = mean(l1_order_channel == "转介绍", na.rm = TRUE)
    ) %>% 
  mutate(
    across(ends_with("rate"), ~ round(.x *100, 1))
    ) %>% 
  group_by(term_label) %>% 
  mutate(rank = round(percent_rank(apply_rate)*100, 0)) %>% 
  group_by(term_label, group_city, group_name) %>%
  arrange(desc(term_label), desc(apply_rate)) %>% 
  relocate(group_cols(),
         starts_with("enroll_"), starts_with("apply_"))

```

Row {.tabset .tabset-fade}
-------------------------------------

### hct组续报率分布

```{r}
gg <- 
  by_term_hct %>%
    filter(!is.na(group_name),
           enroll_total > 10,
           apply_rate > 2) %>%
 ggplot( aes(x = term_label, y = apply_rate)) +
      geom_boxplot() +
      geom_point(aes(color = group_city, text = group_name), size = 1) + 
      labs( x = "", y = "hct组续报率", title = "") +
      scale_color_discrete(name = "基地")
ggplotly(gg)
```

### ct续报率分布

```{r}
gg <- 
  by_term_hct_ct %>%
    filter(!is.na(group_name),
           enroll_total > 10,
           apply_rate > 0.1) %>%
 ggplot( aes(x = term_label, y = apply_rate)) +
      geom_boxplot() +
      geom_point(aes(color = group_city, text = counselor_name), size = 0.5) + 
      labs( x = "", y = "ct续报率", title = "") +
      scale_color_discrete(name = "基地")
ggplotly(gg)
```

```{r eval=FALSE, include=FALSE}
res <- by_term_hct %>%
  filter(!is.na(group_name),
         enroll_total > 10,
         apply_rate > 2)


hcboxplot(
  x = res$apply_rate,
  var = res$term_label,
  name = "Length",
  color = "black",
  outliers = TRUE
) %>%
  hc_chart(type = "column") %>%
  hc_title(text = "") %>%
  hc_yAxis(title = list(text = "hct组续报率"),
           labels = list(format = "{value}%")) %>%
  hc_add_series(
    data = res, type = "scatter",
    hcaes(x = "term_label", y = "apply_rate", group = "group_city")
  ) %>%
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(scatter = list(
    #color = "red",
    marker = list(
      radius = 3,
      symbol = "circle",
      lineWidth = 1
    ),
    jitter = list(x = .1, y = 0)
  )) %>% 
  hc_tooltip(useHTML = TRUE,
             headerFormat = "{series.name} \n
                            学期: {point.x}
                            续报率: {point.y}",
             pointFormat = "")
```

```{r eval=FALSE, include=FALSE}
res <- data_to_boxplot(by_term_hct %>% filter(enroll_total > 10, apply_rate > 2),
                       apply_rate, group_city, term_label)

highchart() %>% 
  hc_xAxis(type = "category") %>% 
  hc_add_series_list(res)
```

Row
-------------------------------------

```{r}
res <- dat %>%
  filter(
    classopen_date > Sys.Date() - 30*2,
    str_detect(term_label, "常规|分层"),
    !str_detect(term_label, "1435")
    ) %>% 
  mutate(ct_level = ifelse(n_term == 1, "新ct", "老ct")) %>% 
  group_by(term_label, ct_level) %>% 
  summarise(
      .groups = "keep",
      enroll_total = n_distinct(user_id, na.rm = TRUE),
      apply_total = n_distinct(ifelse(is_apply == 1, user_id, NA), na.rm = TRUE),
      apply_rate = apply_total/enroll_total,
      apply_high_rate = n_distinct(ifelse((is_apply == 1 & package_grade == "HIGH"),
                        user_id, NA), na.rm = TRUE)/n_distinct(ifelse(package_grade == "HIGH",
                        user_id, NA), na.rm = TRUE),
      apply_low_rate = n_distinct(ifelse((is_apply == 1 & package_grade == "LOW"),
                  user_id, NA), na.rm = TRUE)/n_distinct(ifelse(package_grade == "LOW",
                  user_id, NA), na.rm = TRUE),
      add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
      unit1_attend_rate = mean(ifelse(is.na(unit1_attend_time), 0, 1)),
      unit5_finish_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1)),
      unit5_apply_rate = apply_rate/unit5_finish_rate
      ) %>% 
    mutate(
      across(ends_with("rate"), ~ round(.x *100, 1))
      ) %>% 
    filter(apply_rate > 2, enroll_total > 50)
```

### 新老ct加微信率

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_label, y = add_wx_rate, group = ct_level)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "率") %>% 
  hc_colors(c("#00b6eb","#c9a215","grey")) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### 新老ct首课到课率

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_label, y = unit1_attend_rate, group = ct_level)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "率") %>% 
  hc_colors(c("#00b6eb","#c9a215","grey")) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### 新老ct完课率

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_label, y = unit5_finish_rate, group = ct_level)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "5课完课率") %>% 
  hc_colors(c("#00b6eb","#c9a215","grey")) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### 新老ct完课续报率

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_label, y = unit5_apply_rate, group = ct_level)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "完课续报率") %>% 
  hc_colors(c("#00b6eb","#c9a215","grey")) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE),
            marker = list(radius = 3)
          ))
```

Row
-------------------------------------

```{r}
res <- dat %>%
  filter(
    classopen_date > Sys.Date() - 30*2,
    str_detect(term_label, "常规|分层"),
    !str_detect(term_label, "1435")
    ) %>% 
  group_by(term_label, staff_gender) %>% 
  summarise(
      .groups = "keep",
      enroll_total = n_distinct(user_id, na.rm = TRUE),
      apply_total = n_distinct(ifelse(is_apply == 1, user_id, NA), na.rm = TRUE),
      apply_rate = apply_total/enroll_total,
      apply_high_rate = n_distinct(ifelse((is_apply == 1 & package_grade == "HIGH"),
                        user_id, NA), na.rm = TRUE)/n_distinct(ifelse(package_grade == "HIGH",
                        user_id, NA), na.rm = TRUE),
      apply_low_rate = n_distinct(ifelse((is_apply == 1 & package_grade == "LOW"),
                  user_id, NA), na.rm = TRUE)/n_distinct(ifelse(package_grade == "LOW",
                  user_id, NA), na.rm = TRUE),
      add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
      unit1_attend_rate = mean(ifelse(is.na(unit1_attend_time), 0, 1)),
      unit5_finish_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1)),
      unit5_apply_rate = apply_rate/unit5_finish_rate
      ) %>% 
    mutate(
      across(ends_with("rate"), ~ round(.x *100, 1))
      ) %>% 
    filter(apply_rate > 2, enroll_total > 50)
```

### ct加微信率

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_label, y = add_wx_rate, group = staff_gender)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "率") %>% 
  hc_colors(c("#ee6bda", "#00b6eb", "grey")) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### ct首课到课率

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_label, y = unit1_attend_rate, group = staff_gender)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "率") %>% 
  hc_colors(c("#ee6bda", "#00b6eb", "grey")) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### ct完课率

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_label, y = unit5_finish_rate, group = staff_gender)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "5课完课率") %>% 
  hc_colors(c("#ee6bda", "#00b6eb", "grey")) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE)
          ))
```

### ct完课续报率

```{r}
highchart() %>% 
  hc_add_series(res, type = "line", 
                hcaes(x = term_label, y = unit5_apply_rate, group = staff_gender)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label)) %>% 
  hc_yAxis(title = "完课续报率") %>% 
  hc_colors(c("#ee6bda", "#00b6eb", "grey")) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
          series = list(
            dataLabels = list(enabled = TRUE),
            marker = list(radius = 3)
          ))
```

Row {.tabset .tabset-fade data-height=750}
-------------------------------------

### hct

```{r}
showDT(by_term_hct)
```

### ct

备注： 当期排名（0%～100%），数值越大，代表续报率越高。

```{r}
showDT(by_term_hct_ct %>% select(-term_id, -classopen_date))
```

大盘用户
=====================================

少儿常规大盘用户结构占比及续报率

```{r}
getRates_plot <- function(grp_data) {
  grp_data %>% 
    summarise(
      enroll_total = n_distinct(user_id, na.rm = TRUE), 
      apply_total = n_distinct(ifelse(!is.na(renewal_pay_time),user_id, NA), na.rm = TRUE),
      apply_rate = round(apply_total/enroll_total*100, 1),
      .groups = "drop_last"
    ) %>% 
    mutate(
      enroll_rate = round(enroll_total/sum(enroll_total)*100, 0),
      across(ends_with("rate"), ~ ifelse(.x < 1, NA, .x))
      )
}

grp_data <- dat %>% 
  filter(
    classopen_date > Sys.Date() - 30*1.5,
    str_detect(term_label, "常规")
    ) %>% 
  group_by(term_label)
```

leads
-------------------------------------

```{r}
res <- grp_data %>% 
  group_by(user_level, .add = TRUE) %>% 
  getRates_plot()
```

### leads进班等级占比

```{r}
highchart() %>% 
  hc_add_series(res, "line", 
              hcaes(x = term_label, y = enroll_rate, group = user_level),
              dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_colors(c("lightgrey","#00b6eb","#c9a215","#ee6bda")) %>% 
  hc_legend(verticalAlign = "top")
```

### leads进班等级续报率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1, apply_rate>1), "line", 
                hcaes(x = term_label, y = apply_rate, group = user_level),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_add_series(filter(res, enroll_rate > 1, apply_rate>1), type = "scatter", 
                hcaes(x = term_label, y = apply_rate, group = user_level, 
                      size = enroll_rate), maxSize = "7%") %>%
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_colors(c("#00b6eb","#c9a215","#ee6bda")) %>% 
  hc_legend(verticalAlign = "top")
```

渠道
-------------------------------------

```{r}
res <- grp_data %>% 
  group_by(l1_order_channel, .add = TRUE) %>% 
  getRates_plot()
```

### 渠道占比

```{r}
highchart() %>% 
  hc_add_series(res, "line", 
                hcaes(x = term_label, y = enroll_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_colors(c(color$channel,"lightgrey"))
```

### 渠道续报率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate>1, apply_rate>1), "line", 
                hcaes(x = term_label, y = apply_rate, group = l1_order_channel),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_colors(color$channel) %>%
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_legend(verticalAlign = "top")
```

高低课
-------------------------------------

```{r}
res <- grp_data %>% 
  group_by(package_grade, .add = TRUE) %>% 
  getRates_plot()
```

### 高低课占比

```{r}
highchart() %>% 
  hc_add_series(res, "line", 
                hcaes(x = term_label, y = enroll_rate, group = package_grade),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_colors(c("#00b6eb","#c9a215","lightgrey")) %>%
  hc_legend(verticalAlign = "top")
```

### 高低课续报率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1, apply_rate>1), "line", 
                hcaes(x = term_label, y = apply_rate, group = package_grade),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_add_series(filter(res, enroll_rate > 1, apply_rate>1), type = "scatter", 
                hcaes(x = term_label, y = apply_rate, group = package_grade, 
                      size = enroll_rate), maxSize = "7%") %>%
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_colors(c("#00b6eb","#c9a215","lightgrey"))
```

年级
-------------------------------------

```{r}
res <- grp_data %>% 
  group_by(pay_grade, .add = TRUE) %>% 
  getRates_plot()
```

### 年级占比

```{r}
highchart() %>% 
  hc_add_series(res, "line", 
                hcaes(x = term_label, y = enroll_rate, group = pay_grade),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_legend(verticalAlign = "top")
```

### 年级续报率

```{r}
res <- res %>% filter(enroll_rate > 1, apply_rate > 2)

highchart() %>% 
  hc_add_series(res, "line", 
                hcaes(x = term_label, y = apply_rate, group = pay_grade)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
        series = list(
          dataLabels = list(enabled = TRUE)
        ))
```

城市
-------------------------------------

```{r}
res <- grp_data %>% 
  group_by(phone_city_level, .add = TRUE) %>% 
  getRates_plot()
```

### 城市占比

```{r}

highchart() %>% 
  hc_add_series(res, "line", hcaes(x = term_label, y = enroll_rate, group = phone_city_level)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_colors(c(rep("#00b6eb",3),rep("#c9a215",3),"lightgrey")) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
        series = list(
          dataLabels = list(enabled = TRUE)
        ))

``` 

### 城市续报率

```{r}
res <- res %>% filter(enroll_rate > 1, apply_rate > 2, !is.na(phone_city_level))

highchart() %>% 
  hc_add_series(res, "line", 
                hcaes(x = term_label, y = apply_rate, group = phone_city_level)) %>% 
  hc_add_series(res, type = "scatter", 
                hcaes(x = term_label, y = apply_rate, group = phone_city_level, size = enroll_rate),
                maxSize = "5%", dataLabels = list(enabled = FALSE)) %>%
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_colors(c(rep("#00b6eb",3),rep("#c9a215",3))) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_plotOptions(
        series = list(
          dataLabels = list(enabled = TRUE)
        ))
```

学生性别
-------------------------------------

```{r}
res <- grp_data %>% 
  group_by(child_gender, .add = TRUE) %>% 
  getRates_plot()
```

### 学生性别占比

```{r}
highchart() %>% 
  hc_add_series(res, "line", 
                hcaes(x = term_label, y = enroll_rate, group = child_gender),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_colors(c("#ee6bda","#00b6eb","lightgrey","lightgrey"))
```

### 学生性别续报率

```{r}
highchart() %>% 
  hc_add_series(filter(res, enroll_rate > 1, apply_rate>1), "line", 
                hcaes(x = term_label, y = apply_rate, group = child_gender),
                dataLabels = list(enabled = TRUE)) %>% 
  hc_add_series(filter(res, enroll_rate > 1, apply_rate>1), type = "scatter", 
                hcaes(x = term_label, y = apply_rate, group = child_gender, 
                      size = enroll_rate), maxSize = "7%") %>%
  hc_xAxis(title = "", type = "category", categories = unique(res$term_label),
          plotBands = list(list(
              label = list(text = ""),
              color = "rgba(100, 0, 0, 0.1)",
              from = params$cur_x-1, to = params$cur_x))
          ) %>% 
  hc_legend(verticalAlign = "top") %>% 
  hc_colors(c("#00b6eb","#c9a215","lightgrey"))
```


GANDALF
=====================================

Row plot{data-height=400 .tabset}
-------------------------------------

```{r}
by_date <- dat %>%
  filter(l1_pay_time > "2021-01-01") %>%
  mutate(
    l1_pay_time = as.Date(l1_pay_time)) %>% 
  group_by(term_label, l1_pay_time) %>%
  summarise(
    enroll_total = n_distinct(user_id, na.rm = TRUE),
    ct_total = n_distinct(counselor_id, na.rm = TRUE),
    add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
    subscribe_rate = mean(is_subscribe, na.rm = TRUE),
    unit1_attend_rate = mean(ifelse(is.na(unit1_attend_time), 0, 1)),
    unit5_finish_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1)),
    loss_1_5_rate = 1 - unit5_finish_rate/unit1_attend_rate,
    grade_low_rate = mean(package_grade == "LOW", na.rm = TRUE),
    grade_8_rate = mean(pay_grade == 8, na.rm = TRUE),
    referral_rate = mean(l1_order_channel == "转介绍", na.rm = TRUE)
    ) %>%
  mutate(
    across(ends_with("rate"), ~ round(.x *100, 1)),
    across(ends_with("time"), ~ format(.x, "%Y-%m-%d"))
    ) %>%
  filter(
    enroll_total > 100
  ) %>% 
  arrange(desc(term_label), desc(l1_pay_time))
```

```{r}
by_date_join <- dat %>%
  filter(user_class_start_time > "2021-01-01") %>%
  mutate(user_class_start_time = as.Date(user_class_start_time)) %>% 
  group_by(term_label, user_class_start_time) %>%
  summarise(
    enroll_total = n_distinct(user_id, na.rm = TRUE),
    ct_total = n_distinct(counselor_id, na.rm = TRUE),
    add_wx_rate = mean(ifelse(is.na(add_wx_time), 0, 1)),
    subscribe_rate = mean(is_subscribe, na.rm = TRUE),
    unit1_attend_rate = mean(ifelse(is.na(unit1_attend_time), 0, 1)),
    unit5_finish_rate = mean(ifelse(is.na(unit5_finish_time), 0, 1)),
    loss_1_5_rate = 1 - unit5_finish_rate/unit1_attend_rate,
    grade_low_rate = mean(package_grade == "LOW", na.rm = TRUE),
    grade_8_rate = mean(pay_grade == 8, na.rm = TRUE),
    referral_rate = mean(l1_order_channel == "转介绍", na.rm = TRUE)
    ) %>%
  mutate(
    across(ends_with("rate"), ~ round(.x *100, 1)),
    across(ends_with("time"), ~ format(.x, "%Y-%m-%d"))
    ) %>% 
  arrange(desc(term_label), desc(user_class_start_time))
```

### 按购课时间

```{r fig.width=14.5}
gg <-   
  by_date %>% 
  filter(l1_pay_time > Sys.Date() - 30*1) %>% 
  ggplot(aes(x = l1_pay_time, y = add_wx_rate, group = term_label)) +
   geom_line(aes(color = term_label)) +
   geom_point(aes(size = enroll_total, color = term_label), alpha = 0.55) +
   labs(x = "")
ggplotly(gg)

```

```{r}
gg <- 
  by_date %>% 
    filter(l1_pay_time > Sys.Date() - 30*1) %>% 
    arrange(l1_pay_time) %>% 
  ggplot(aes(x = l1_pay_time, y = add_wx_rate, color = term_label)) +
    geom_line()

ggplotly(gg)
```


### 按进班时间

```{r fig.width=14.5}
ggplotly({
  by_date_join %>% 
  filter(
    enroll_total > 10,
    user_class_start_time > Sys.Date() - 30*1) %>% 
  ggplot(aes(x = user_class_start_time, y = add_wx_rate, group = term_label)) +
   geom_line(aes(color = term_label)) +
   geom_point(aes(size = enroll_total, color = term_label), alpha = 0.55) +
   labs(x = "")
})
```


Row {data-height=1000 .tabset}
-------------------------------------

### 按购课时间

```{r}
names_dt <- names(by_date)
DT::datatable(
  by_date,
    class = "display compact",
    #filter = "top",
    colnames = headers[names_dt,],
    rownames = FALSE,
    extensions = 'Buttons', 
    options = list(
      pageLength = 20,
      dom = 'Blfrtip',
      buttons = list('copy', "csv"))
    ) %>%
    formatRound(grepl("rate|prop", names_dt), 2) %>%
    formatStyle(grep("rate|prop", names_dt), fontStyle = "italic")
```

### 按进班时间

```{r}
names_dt <- names(by_date_join)
DT::datatable(
  by_date_join,
    class = "display compact",
    #filter = "top",
    colnames = headers[names_dt,],
    rownames = FALSE,
    extensions = 'Buttons', 
    options = list(
      pageLength = 20,
      dom = 'Blfrtip',
      buttons = list('copy', "csv"))
    ) %>%
    formatRound(grepl("rate|prop", names_dt), 2) %>%
    formatStyle(grep("rate|prop", names_dt), fontStyle = "italic")
```

{data-navmenu="数据更新至 `r max(dat$l1_pay_time, na.rm = TRUE)`"}
=====================================

<!-- 预测 {data-icon="fa-signal"} -->
<!-- =====================================  -->

<!-- ```{r} -->
<!-- res <- readRDS(file = "/Users/hetao/Documents/hetao/data/dat_model_res_20210523.rds") -->
<!-- ``` -->

<!-- Row {data-height=500} -->
<!-- ------------------------------------- -->

<!-- ```{r} -->
<!-- highchart() %>% -->
<!--   hc_add_series(res, "line", hcaes(x = term_label, y = pred_apply_rate), name = "预测续报率") %>% -->
<!--   hc_add_series(res, "line", hcaes(x = term_label, y = apply_rate), name = "实际续报率") %>% -->
<!--   hc_xAxis(title = "", type = "category", categories = res$term_label,  -->
<!--            labels = list(align = "right", rotation =  -45, overflow = none,  -->
<!--                          style = list(textAlign = "right")) ) %>%  -->
<!--   hc_yAxis(text = "续报率") %>%  -->
<!--   hc_legend(verticalAlign = "top") %>%  -->
<!--   hc_plotOptions( -->
<!--           series = list( -->
<!--             dataLabels = list(enabled = TRUE) -->
<!--           )) -->
<!-- ``` -->



